# Production docker-compose using published container images
# Usage: docker-compose -f docker-compose.registry.yml up -d

services:
  amlink-client:
    image: ghcr.io/eduardomb-aw/amlink-submissions-mcp-client:latest
    container_name: amlink-client-prod
    ports:
      - "8080:8080"
      - "8443:8443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=https://+:8443;http://+:8080
      - ASPNETCORE_Kestrel__Certificates__Default__Password=${CERT_PASSWORD}
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
      - McpClient__ServerUrl=https://amlink-server:9443
      - IdentityServer__Authority=https://amlink-server:9443
      - IdentityServer__ClientId=${CLIENT_ID}
      - IdentityServer__ClientSecret=${CLIENT_SECRET}
    volumes:
      - ./certs:/https:ro
    depends_on:
      - amlink-server
    networks:
      - amlink-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  amlink-server:
    image: ghcr.io/eduardomb-aw/amlink-submissions-mcp-server:latest
    container_name: amlink-server-prod
    ports:
      - "9080:9080"
      - "9443:9443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=https://+:9443;http://+:9080
      - ASPNETCORE_Kestrel__Certificates__Default__Password=${CERT_PASSWORD}
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
      - IdentityServer__Issuer=https://amlink-server:9443
      - IdentityServer__Clients__0__ClientId=${CLIENT_ID}
      - IdentityServer__Clients__0__ClientSecret=${CLIENT_SECRET}
      - ExternalApis__SubmissionApi__BaseUrl=${SUBMISSION_API_URL}
      - ExternalApis__SubmissionApi__ApiKey=${SUBMISSION_API_KEY}
    volumes:
      - ./certs:/https:ro
    networks:
      - amlink-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  amlink-network:
    driver: bridge

# To use this file:
# 1. Ensure images are published: Run the "Build and Push Container Images" GitHub Action
# 2. Set up environment: cp .env.example .env.prod && edit .env.prod
# 3. Generate certificates: ./scripts/generate-certs.sh (or use your own)
# 4. Start services: docker-compose -f docker-compose.registry.yml --env-file .env.prod up -d