name: Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate PR
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          9.0.x
          10.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Check code formatting
      run: dotnet format --verify-no-changes --verbosity diagnostic

    - name: Build solution
      run: dotnet build --no-restore --configuration Release

    - name: Run tests with coverage
      run: |
        # Check if test projects exist
        if find . -name "*.csproj" -exec grep -l "Microsoft.NET.Test.Sdk" {} \; | head -1; then
          echo "Test projects found, running tests..."
          dotnet test --no-build --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./test-results \
            --logger "trx;LogFileName=test-results.trx"
          # Move coverage files to separate directory
          mkdir -p ./coverage
          find ./test-results -name "*.coverage" -exec mv {} ./coverage/ \; 2>/dev/null || true
          find ./test-results -name "coverage.cobertura.xml" -exec mv {} ./coverage/ \; 2>/dev/null || true
        else
          echo "No test projects found, skipping test reporting"
          mkdir -p ./test-results ./coverage
        fi

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always() && hashFiles('./test-results/test-results.trx') != ''
      with:
        name: .NET Tests
        path: './test-results/test-results.trx'
        reporter: dotnet-trx

    - name: Docker Build Test
      run: |
        docker build -t test-server ./src/amlink-submissions-mcp-server/
        docker build -t test-client ./src/amlink-submissions-mcp-client/

    - name: Validate Docker Compose
      run: |
        docker-compose -f docker-compose.yml config
        docker-compose -f docker-compose.yml -f docker-compose.prod.yml config

  lint:
    runs-on: ubuntu-latest
    name: Lint & Security
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Super-Linter
      uses: super-linter/super-linter@v5
      env:
        DEFAULT_BRANCH: main
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        VALIDATE_DOCKERFILE_HADOLINT: true
        VALIDATE_YAML: true
        VALIDATE_JSON: true
        VALIDATE_MARKDOWN: true
        # Run only on changed files
        VALIDATE_ALL_CODEBASE: false

    - name: Scan for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD