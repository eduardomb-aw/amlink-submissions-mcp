name: Build and Push Container Images

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag (default: latest)'
        required: false
        default: 'latest'
      registry:
        description: 'Container registry'
        required: false
        default: 'ghcr.io'
        type: choice
        options:
          - 'ghcr.io'
          - 'docker.io'
      skip_ci_check:
        description: 'Skip CI status check (not recommended)'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*'
  release:
    types: [published]

env:
  REGISTRY: ${{ github.event.inputs.registry || 'ghcr.io' }}
  IMAGE_TAG: ${{ github.event.inputs.tag || github.ref_name || 'latest' }}

jobs:
  check-ci-status:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.skip_ci_check != 'true'
    outputs:
      ci-passed: ${{ steps.check.outputs.result }}
    
    steps:
    - name: Check CI Pipeline Status
      id: check
      uses: actions/github-script@v7
      with:
        script: |
          // For manual triggers, check if CI passed on the current commit
          const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'ci-cd.yml',
            head_sha: context.sha,
            status: 'completed'
          });
          
          const ciRun = runs.workflow_runs[0];
          if (!ciRun || ciRun.conclusion !== 'success') {
            core.setFailed(`CI pipeline has not passed for commit ${context.sha}. Please ensure CI is green before publishing images.`);
            return 'failed';
          }
          
          core.info(`âœ… CI pipeline passed for commit ${context.sha}`);
          return 'success';

  build-and-push:
    runs-on: ubuntu-latest
    needs: [check-ci-status]
    if: always() && (needs.check-ci-status.result == 'success' || needs.check-ci-status.result == 'skipped')
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for client
      id: meta-client
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}-client
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=ref,event=tag
          type=raw,value=${{ env.IMAGE_TAG }}
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha

    - name: Extract metadata for server
      id: meta-server
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}-server
        tags: |
          type=ref,event=branch
          type=ref,event=tag
          type=ref,event=pr
          type=raw,value=${{ env.IMAGE_TAG }}
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha

    - name: Build and push client image
      uses: docker/build-push-action@v5
      with:
        context: ./src/amlink-submissions-mcp-client
        file: ./src/amlink-submissions-mcp-client/Dockerfile
        push: true
        tags: ${{ steps.meta-client.outputs.tags }}
        labels: ${{ steps.meta-client.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push server image
      uses: docker/build-push-action@v5
      with:
        context: ./src/amlink-submissions-mcp-server
        file: ./src/amlink-submissions-mcp-server/Dockerfile
        push: true
        tags: ${{ steps.meta-server.outputs.tags }}
        labels: ${{ steps.meta-server.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Generate image summary
      run: |
        echo "## ðŸ³ Container Images Published" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Client Image" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** \`${{ env.REGISTRY }}/${{ github.repository }}-client\`" >> $GITHUB_STEP_SUMMARY
        echo "**Tags:** \`${{ steps.meta-client.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Server Image" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** \`${{ env.REGISTRY }}/${{ github.repository }}-server\`" >> $GITHUB_STEP_SUMMARY
        echo "**Tags:** \`${{ steps.meta-server.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Usage" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Pull and run client" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}-client:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Pull and run server" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}-server:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      security-events: write
      
    steps:
    - name: Run Trivy vulnerability scanner on client image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ github.repository }}-client:${{ env.IMAGE_TAG }}
        format: 'sarif'
        output: 'trivy-client-results.sarif'

    - name: Upload client Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-client-results.sarif'
        category: 'client-image'

    - name: Run Trivy vulnerability scanner on server image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ github.repository }}-server:${{ env.IMAGE_TAG }}
        format: 'sarif'
        output: 'trivy-server-results.sarif'

    - name: Upload server Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-server-results.sarif'
        category: 'server-image'

  summary:
    runs-on: ubuntu-latest
    needs: [check-ci-status, build-and-push, security-scan]
    if: always()
    
    steps:
    - name: Pipeline Summary
      run: |
        echo "## ðŸ³ Container Publishing Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This workflow focuses on **publishing validated code** to container registries." >> $GITHUB_STEP_SUMMARY
        echo "Code validation (build, test, security) happens in the main CI pipeline." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CI Status Check | ${{ needs.check-ci-status.result == 'success' && 'âœ… Passed' || needs.check-ci-status.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Image Publishing | ${{ needs.build-and-push.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Image Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Success' || needs.security-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Published Images" >> $GITHUB_STEP_SUMMARY
        echo "**Registry:** \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.build-and-push.result }}" == "success" ]]; then
          echo "âœ… **Images are ready for deployment!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use the deployment scripts or docker-compose.registry.yml to deploy these images." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Image publishing failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the build logs and try again." >> $GITHUB_STEP_SUMMARY
        fi