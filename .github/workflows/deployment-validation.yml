name: Deployment Validation

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Container image tag to validate'
        required: true
        default: 'latest'
        type: string
      environment:
        description: 'Deployment environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - 'staging'
          - 'test'
          - 'demo'
      skip_health_checks:
        description: 'Skip health check validation'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: read

env:
  REGISTRY: ghcr.io
  IMAGE_TAG: ${{ github.event.inputs.image_tag }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}

jobs:
  validate-images:
    runs-on: ubuntu-latest
    outputs:
      client_image: ${{ steps.check.outputs.client_image }}
      server_image: ${{ steps.check.outputs.server_image }}
      images_exist: ${{ steps.check.outputs.images_exist }}
    
    steps:
    - name: Validate container images exist
      id: check
      run: |
        CLIENT_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}-client:${{ env.IMAGE_TAG }}"
        SERVER_IMAGE="${{ env.REGISTRY }}/${{ github.repository }}-server:${{ env.IMAGE_TAG }}"
        
        echo "ðŸ” Checking if container images exist..."
        echo "Client: $CLIENT_IMAGE"
        echo "Server: $SERVER_IMAGE"
        
        # Check if images exist
        if docker manifest inspect "$CLIENT_IMAGE" >/dev/null 2>&1; then
          echo "âœ… Client image exists"
          CLIENT_EXISTS=true
        else
          echo "âŒ Client image not found"
          CLIENT_EXISTS=false
        fi
        
        if docker manifest inspect "$SERVER_IMAGE" >/dev/null 2>&1; then
          echo "âœ… Server image exists"
          SERVER_EXISTS=true
        else
          echo "âŒ Server image not found"
          SERVER_EXISTS=false
        fi
        
        if [[ "$CLIENT_EXISTS" == "true" && "$SERVER_EXISTS" == "true" ]]; then
          echo "âœ… Both images are available"
          echo "images_exist=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ One or more images are missing"
          echo "images_exist=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "client_image=$CLIENT_IMAGE" >> $GITHUB_OUTPUT
        echo "server_image=$SERVER_IMAGE" >> $GITHUB_OUTPUT

  security-scan:
    runs-on: ubuntu-latest
    needs: [validate-images]
    if: needs.validate-images.outputs.images_exist == 'true'
    
    strategy:
      matrix:
        image: [client, server]
      fail-fast: false
    
    steps:
    - name: Run security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ matrix.image == 'client' && needs.validate-images.outputs.client_image || needs.validate-images.outputs.server_image }}
        format: 'table'
        output: 'scan-results-${{ matrix.image }}.txt'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  # Don't fail on vulnerabilities, just report

    - name: Upload scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-${{ matrix.image }}-${{ env.IMAGE_TAG }}
        path: scan-results-${{ matrix.image }}.txt

  deployment-test:
    runs-on: ubuntu-latest
    needs: [validate-images]
    if: needs.validate-images.outputs.images_exist == 'true'
    
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up test environment
      run: |
        # Create test environment file
        cat > .env.test << EOF
        CERT_PASSWORD=TestPassword123!
        CLIENT_ID=test-client
        CLIENT_SECRET=test-secret-12345
        SUBMISSION_API_URL=https://api.example.com/test
        SUBMISSION_API_KEY=test-api-key
        EOF
        
        # Create test certificates directory
        mkdir -p certs-test
        
        # Generate test certificates
        openssl req -x509 -newkey rsa:4096 -keyout certs-test/aspnetapp.key -out certs-test/aspnetapp.crt \
          -days 365 -nodes -subj "/CN=localhost"
        openssl pkcs12 -export -out certs-test/aspnetapp.pfx -inkey certs-test/aspnetapp.key \
          -in certs-test/aspnetapp.crt -password pass:TestPassword123!

    - name: Create test docker-compose
      run: |
        cat > docker-compose.test.yml << EOF
        services:
          amlink-client-test:
            image: ${{ needs.validate-images.outputs.client_image }}
            container_name: amlink-client-test-${{ env.ENVIRONMENT }}
            ports:
              - "18080:8080"
              - "18443:8443"
            environment:
              - ASPNETCORE_ENVIRONMENT=Production
              - ASPNETCORE_URLS=https://+:8443;http://+:8080
              - ASPNETCORE_Kestrel__Certificates__Default__Password=TestPassword123!
              - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
              - McpClient__ServerUrl=https://amlink-server-test:9443
              - IdentityServer__Authority=https://amlink-server-test:9443
              - IdentityServer__ClientId=test-client
              - IdentityServer__ClientSecret=test-secret-12345
            volumes:
              - ./certs-test:/https:ro
            depends_on:
              - amlink-server-test
            networks:
              - test-network
        
          amlink-server-test:
            image: ${{ needs.validate-images.outputs.server_image }}
            container_name: amlink-server-test-${{ env.ENVIRONMENT }}
            ports:
              - "19080:9080"
              - "19443:9443"
            environment:
              - ASPNETCORE_ENVIRONMENT=Production
              - ASPNETCORE_URLS=https://+:9443;http://+:9080
              - ASPNETCORE_Kestrel__Certificates__Default__Password=TestPassword123!
              - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
              - IdentityServer__Issuer=https://amlink-server-test:9443
              - IdentityServer__Clients__0__ClientId=test-client
              - IdentityServer__Clients__0__ClientSecret=test-secret-12345
              - ExternalApis__SubmissionApi__BaseUrl=https://api.example.com/test
              - ExternalApis__SubmissionApi__ApiKey=test-api-key
            volumes:
              - ./certs-test:/https:ro
            networks:
              - test-network
        
        networks:
          test-network:
            driver: bridge
        EOF

    - name: Deploy test environment
      run: |
        echo "ðŸš€ Starting test deployment..."
        docker-compose -f docker-compose.test.yml up -d
        
        echo "â³ Waiting for services to start..."
        sleep 30

    - name: Health check validation
      if: github.event.inputs.skip_health_checks != 'true'
      run: |
        echo "ðŸ” Running health checks..."
        
        # Function to check health endpoint
        check_health() {
          local url=$1
          local service=$2
          local max_attempts=10
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "[$attempt/$max_attempts] Checking $service health..."
            
            if curl -f -k --connect-timeout 10 --max-time 30 "$url" >/dev/null 2>&1; then
              echo "âœ… $service is healthy"
              return 0
            fi
            
            echo "â³ $service not ready, waiting..."
            sleep 15
            attempt=$((attempt + 1))
          done
          
          echo "âŒ $service health check failed after $max_attempts attempts"
          return 1
        }
        
        # Check server health (HTTP)
        check_health "http://localhost:19080/health" "Server"
        
        # Check client health (HTTP)
        check_health "http://localhost:18080/health" "Client"
        
        echo "âœ… All health checks passed!"

    - name: Connectivity test
      run: |
        echo "ðŸ”— Testing service connectivity..."
        
        # Test server endpoints
        echo "Testing server endpoints..."
        curl -f -k --connect-timeout 10 --max-time 30 http://localhost:19080/health || echo "Server HTTP health check failed"
        curl -f -k --connect-timeout 10 --max-time 30 https://localhost:19443/health || echo "Server HTTPS health check failed (expected with self-signed cert)"
        
        # Test client endpoints
        echo "Testing client endpoints..."
        curl -f -k --connect-timeout 10 --max-time 30 http://localhost:18080/health || echo "Client HTTP health check failed"
        curl -f -k --connect-timeout 10 --max-time 30 https://localhost:18443/health || echo "Client HTTPS health check failed (expected with self-signed cert)"
        
        echo "âœ… Connectivity tests completed"

    - name: Collect deployment logs
      if: always()
      run: |
        echo "ðŸ“‹ Collecting deployment logs..."
        
        mkdir -p deployment-logs
        
        # Get container logs
        docker-compose -f docker-compose.test.yml logs > deployment-logs/docker-compose.log 2>&1 || true
        docker logs amlink-server-test-${{ env.ENVIRONMENT }} > deployment-logs/server.log 2>&1 || true
        docker logs amlink-client-test-${{ env.ENVIRONMENT }} > deployment-logs/client.log 2>&1 || true
        
        # Get container status
        docker-compose -f docker-compose.test.yml ps > deployment-logs/container-status.txt 2>&1 || true

    - name: Upload deployment logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: deployment-logs-${{ env.IMAGE_TAG }}-${{ env.ENVIRONMENT }}
        path: deployment-logs/

    - name: Cleanup test environment
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up test environment..."
        docker-compose -f docker-compose.test.yml down --remove-orphans --volumes || true
        docker system prune -f || true

  validation-summary:
    runs-on: ubuntu-latest
    needs: [validate-images, security-scan, deployment-test]
    if: always()
    
    steps:
    - name: Generate validation summary
      run: |
        echo "## ðŸ§ª Deployment Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: \`${{ env.ENVIRONMENT }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Image Validation | ${{ needs.validate-images.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Completed' || needs.security-scan.result == 'skipped' && 'â­ï¸  Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment Test | ${{ needs.deployment-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.validate-images.result }}" == "success" && "${{ needs.deployment-test.result }}" == "success" ]]; then
          echo "### âœ… Validation Successful!" >> $GITHUB_STEP_SUMMARY
          echo "The container images for tag \`${{ env.IMAGE_TAG }}\` are ready for deployment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validated Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ needs.validate-images.outputs.client_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ needs.validate-images.outputs.server_image }}\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
          echo "One or more validation steps failed. Please review the logs and artifacts." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Artifacts**: Check the workflow artifacts for detailed logs and scan results." >> $GITHUB_STEP_SUMMARY