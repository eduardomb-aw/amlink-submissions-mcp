name: Provision Web Apps Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - 'staging'
          - 'production'
      location:
        description: 'Azure region'
        required: true
        default: 'East US 2'
        type: string

permissions:
  contents: read

jobs:
  provision-infrastructure:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      run: |
        az login --service-principal \
          --username "${{ secrets.AZURE_CLIENT_ID }}" \
          --password "${{ secrets.AZURE_CLIENT_SECRET }}" \
          --tenant "${{ secrets.AZURE_TENANT_ID }}"
        
        az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
        echo "âœ… Logged in to Azure"

    - name: Set environment variables
      run: |
        ENV="${{ github.event.inputs.environment }}"
        LOCATION="${{ github.event.inputs.location }}"
        
        if [[ "$ENV" == "production" ]]; then
          echo "RESOURCE_GROUP=rg-amlink-submissions-mcp-prod" >> $GITHUB_ENV
          echo "CLIENT_APP_NAME=app-amlink-submissions-mcp-prod-client" >> $GITHUB_ENV
          echo "SERVER_APP_NAME=app-amlink-submissions-mcp-prod-server" >> $GITHUB_ENV
          echo "APP_SERVICE_PLAN=asp-amlink-submissions-mcp-prod" >> $GITHUB_ENV
        else
          echo "RESOURCE_GROUP=rg-amlink-submissions-mcp-staging" >> $GITHUB_ENV
          echo "CLIENT_APP_NAME=app-amlink-submissions-mcp-staging-client" >> $GITHUB_ENV
          echo "SERVER_APP_NAME=app-amlink-submissions-mcp-staging-server" >> $GITHUB_ENV
          echo "APP_SERVICE_PLAN=asp-amlink-submissions-mcp-staging" >> $GITHUB_ENV
        fi
        
        echo "LOCATION=$LOCATION" >> $GITHUB_ENV
        echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV

    - name: Create Resource Group
      run: |
        echo "ðŸ—ï¸ Creating resource group: $RESOURCE_GROUP"
        az group create \
          --name "$RESOURCE_GROUP" \
          --location "$LOCATION" \
          --tags \
            environment="$ENVIRONMENT" \
            project="amlink-mcp" \
            managed-by="github-actions"
        
        echo "âœ… Resource group created successfully"

    - name: Create App Service Plan
      run: |
        echo "ðŸ—ï¸ Creating App Service Plan: $APP_SERVICE_PLAN"
        az appservice plan create \
          --name "$APP_SERVICE_PLAN" \
          --resource-group "$RESOURCE_GROUP" \
          --location "$LOCATION" \
          --is-linux \
          --sku "B1" \
          --tags \
            environment="$ENVIRONMENT" \
            project="amlink-mcp"
        
        echo "âœ… App Service Plan created successfully"

    - name: Create Client Web App
      run: |
        echo "ðŸŒ Creating Client Web App: $CLIENT_APP_NAME"
        az webapp create \
          --name "$CLIENT_APP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --plan "$APP_SERVICE_PLAN" \
          --deployment-container-image-name "ghcr.io/eduardomb-aw/amlink-submissions-mcp-client:latest" \
          --tags \
            environment="$ENVIRONMENT" \
            project="amlink-mcp" \
            app-type="client"
        
        # Configure container registry authentication
        az webapp config appsettings set \
          --name "$CLIENT_APP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --settings \
            "DOCKER_REGISTRY_SERVER_URL=https://ghcr.io" \
            "DOCKER_REGISTRY_SERVER_USERNAME=${{ github.actor }}" \
            "DOCKER_REGISTRY_SERVER_PASSWORD=${{ secrets.GITHUB_TOKEN }}"
        
        # Wait for web app to be fully provisioned
        echo "â³ Waiting for client web app to be fully provisioned..."
        sleep 10
        
        echo "âœ… Client Web App created successfully"

    - name: Create Server Web App
      run: |
        echo "ðŸ–¥ï¸ Creating Server Web App: $SERVER_APP_NAME"
        az webapp create \
          --name "$SERVER_APP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --plan "$APP_SERVICE_PLAN" \
          --deployment-container-image-name "ghcr.io/eduardomb-aw/amlink-submissions-mcp-server:latest" \
          --tags \
            environment="$ENVIRONMENT" \
            project="amlink-mcp" \
            app-type="server"
        
        # Configure container registry authentication
        az webapp config appsettings set \
          --name "$SERVER_APP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --settings \
            "DOCKER_REGISTRY_SERVER_URL=https://ghcr.io" \
            "DOCKER_REGISTRY_SERVER_USERNAME=${{ github.actor }}" \
            "DOCKER_REGISTRY_SERVER_PASSWORD=${{ secrets.GITHUB_TOKEN }}"
        
        # Wait for web app to be fully provisioned
        echo "â³ Waiting for server web app to be fully provisioned..."
        sleep 10
        
        echo "âœ… Server Web App created successfully"

    - name: Configure Basic Settings
      run: |
        echo "âš™ï¸ Configuring basic application settings..."
        
        # Configure client app settings
        az webapp config appsettings set \
          --name "$CLIENT_APP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --settings \
            ASPNETCORE_ENVIRONMENT="$ENVIRONMENT" \
            ASPNETCORE_URLS="http://+:8080" \
            WEBSITES_PORT="8080" \
            McpServer__Url="https://$SERVER_APP_NAME.azurewebsites.net/" \
            McpServer__BrowserUrl="https://$SERVER_APP_NAME.azurewebsites.net/"
        
        # Configure server app settings
        az webapp config appsettings set \
          --name "$SERVER_APP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --settings \
            ASPNETCORE_ENVIRONMENT="$ENVIRONMENT" \
            ASPNETCORE_URLS="http://+:8080" \
            WEBSITES_PORT="8080"
        
        echo "âœ… Basic settings configured"

    - name: Configure VNet Integration
      run: |
        echo "ðŸŒ Configuring VNet Integration..."
        
        # VNet configuration for Architecture Playground
        VNET_RESOURCE_GROUP="NewAFormentiRG"
        VNET_NAME="ArchPlayGroundAFRG-1"
        SUBNET_NAME="5"
        
        # Get VNet and subnet resource IDs
        VNET_ID=$(az network vnet show \
          --resource-group "$VNET_RESOURCE_GROUP" \
          --name "$VNET_NAME" \
          --query "id" \
          --output tsv)
        
        SUBNET_ID=$(az network vnet subnet show \
          --resource-group "$VNET_RESOURCE_GROUP" \
          --vnet-name "$VNET_NAME" \
          --name "$SUBNET_NAME" \
          --query "id" \
          --output tsv)
        
        if [[ -z "$VNET_ID" || -z "$SUBNET_ID" ]]; then
          echo "âŒ Failed to find VNet or subnet"
          echo "VNet ID: $VNET_ID"
          echo "Subnet ID: $SUBNET_ID"
          exit 1
        fi
        
        echo "âœ… Found VNet: $VNET_ID"
        echo "âœ… Found Subnet: $SUBNET_ID"
        
        # Check if subnet is delegated to Web Apps
        DELEGATIONS=$(az network vnet subnet show \
          --resource-group "$VNET_RESOURCE_GROUP" \
          --vnet-name "$VNET_NAME" \
          --name "$SUBNET_NAME" \
          --query "delegations[?serviceName=='Microsoft.Web/serverFarms'].serviceName" \
          --output tsv)
        
        if [[ -z "$DELEGATIONS" ]]; then
          echo "ðŸ”§ Adding subnet delegation for Web Apps..."
          az network vnet subnet update \
            --resource-group "$VNET_RESOURCE_GROUP" \
            --vnet-name "$VNET_NAME" \
            --name "$SUBNET_NAME" \
            --delegations Microsoft.Web/serverFarms \
            --output none
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… Subnet delegation added successfully"
          else
            echo "âŒ Failed to add subnet delegation"
            exit 1
          fi
        else
          echo "âœ… Subnet already delegated to Microsoft.Web/serverFarms"
        fi
        
        # Configure VNet integration for Client Web App
        echo "ðŸ”— Configuring Client Web App VNet integration..."
        az webapp vnet-integration add \
          --resource-group "$RESOURCE_GROUP" \
          --name "$CLIENT_APP_NAME" \
          --vnet "$VNET_ID" \
          --subnet "$SUBNET_ID" \
          --output none 2>/dev/null || echo "âš ï¸ Client App VNet integration may already exist"
        
        # Verify client VNet integration
        CLIENT_VNET_CONFIG=$(az webapp vnet-integration list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$CLIENT_APP_NAME" \
          --query "[0].vnetResourceId" \
          --output tsv 2>/dev/null)
        
        if [[ -n "$CLIENT_VNET_CONFIG" ]]; then
          echo "âœ… Client Web App VNet integration verified"
        else
          echo "âš ï¸ Client Web App VNet integration not found"
        fi
        
        # Configure VNet integration for Server Web App
        echo "ðŸ”— Configuring Server Web App VNet integration..."
        az webapp vnet-integration add \
          --resource-group "$RESOURCE_GROUP" \
          --name "$SERVER_APP_NAME" \
          --vnet "$VNET_ID" \
          --subnet "$SUBNET_ID" \
          --output none 2>/dev/null || echo "âš ï¸ Server App VNet integration may already exist"
        
        # Verify server VNet integration
        SERVER_VNET_CONFIG=$(az webapp vnet-integration list \
          --resource-group "$RESOURCE_GROUP" \
          --name "$SERVER_APP_NAME" \
          --query "[0].vnetResourceId" \
          --output tsv 2>/dev/null)
        
        if [[ -n "$SERVER_VNET_CONFIG" ]]; then
          echo "âœ… Server Web App VNet integration verified"
        else
          echo "âš ï¸ Server Web App VNet integration not found"
        fi
        
        echo "âœ… VNet Integration configuration completed"

    - name: Infrastructure Summary
      run: |
        CLIENT_URL="https://$CLIENT_APP_NAME.azurewebsites.net"
        SERVER_URL="https://$SERVER_APP_NAME.azurewebsites.net"
        
        echo "## ðŸ—ï¸ Infrastructure Provisioned Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** \`$ENVIRONMENT\`" >> $GITHUB_STEP_SUMMARY
        echo "**Location:** \`$LOCATION\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Resources Created" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group:** \`$RESOURCE_GROUP\`" >> $GITHUB_STEP_SUMMARY
        echo "- **App Service Plan:** \`$APP_SERVICE_PLAN\` (B1 Linux)" >> $GITHUB_STEP_SUMMARY
        echo "- **Client Web App:** [\`$CLIENT_APP_NAME\`]($CLIENT_URL)" >> $GITHUB_STEP_SUMMARY
        echo "- **Server Web App:** [\`$SERVER_APP_NAME\`]($SERVER_URL)" >> $GITHUB_STEP_SUMMARY
        echo "- **VNet Integration:** \`ArchPlayGroundAFRG-1/5\` (East US 2)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Application URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Client (Web UI):** [$CLIENT_URL]($CLIENT_URL)" >> $GITHUB_STEP_SUMMARY
        echo "- **Server (API/MCP):** [$SERVER_URL]($SERVER_URL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš™ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Run deployment pipeline to configure applications and deploy containers" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify VNet integration and internal resource connectivity" >> $GITHUB_STEP_SUMMARY
        echo "3. Test Identity Server authentication and MCP functionality" >> $GITHUB_STEP_SUMMARY
        echo "4. Configure any additional network security rules if needed" >> $GITHUB_STEP_SUMMARY