name: Update Web Apps Container Images

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Container image tag to deploy'
        required: true
        default: 'latest'
        type: string

permissions:
  contents: read
  packages: read
  id-token: write

env:
  AZURE_RESOURCE_GROUP: rg-amlink-submissions-mcp-staging
  IMAGE_TAG: ${{ github.event.inputs.image_tag || github.event.release.tag_name || 'latest' }}
  CLIENT_APP_NAME: app-amlink-submissions-mcp-staging-client
  SERVER_APP_NAME: app-amlink-submissions-mcp-staging-server

jobs:
  update-webapp-containers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Azure Login
      run: |
        az login --service-principal \
          --username ${{ secrets.AZURE_CLIENT_ID }} \
          --password ${{ secrets.AZURE_CLIENT_SECRET }} \
          --tenant ${{ secrets.AZURE_TENANT_ID }}
        
        az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Update Client Web App Container
      run: |
        echo "ðŸš€ Updating client web app container to tag: ${{ env.IMAGE_TAG }}"
        az webapp config container set \
          --name ${{ env.CLIENT_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --docker-custom-image-name "ghcr.io/eduardomb-aw/amlink-submissions-mcp-client:${{ env.IMAGE_TAG }}" \
          --docker-registry-server-url "https://ghcr.io" \
          --docker-registry-server-user "${{ github.actor }}" \
          --docker-registry-server-password "${{ secrets.GITHUB_TOKEN }}"
        
        echo "âœ… Client container updated successfully"

    - name: Update Server Web App Container  
      run: |
        echo "ðŸš€ Updating server web app container to tag: ${{ env.IMAGE_TAG }}"
        az webapp config container set \
          --name ${{ env.SERVER_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --docker-custom-image-name "ghcr.io/eduardomb-aw/amlink-submissions-mcp-server:${{ env.IMAGE_TAG }}" \
          --docker-registry-server-url "https://ghcr.io" \
          --docker-registry-server-user "${{ github.actor }}" \
          --docker-registry-server-password "${{ secrets.GITHUB_TOKEN }}"
        
        echo "âœ… Server container updated successfully"

    - name: Restart Web Apps
      run: |
        echo "ðŸ”„ Restarting web apps to apply new containers..."
        
        # Restart both apps in parallel
        az webapp restart --name ${{ env.CLIENT_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &
        az webapp restart --name ${{ env.SERVER_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} &
        
        # Wait for both restarts to complete
        wait
        
        echo "âœ… Both web apps restarted successfully"

    - name: Wait for apps to be ready
      run: |
        echo "â³ Waiting for applications to be ready..."
        sleep 60

    - name: Verify deployment
      run: |
        CLIENT_URL="https://${{ env.CLIENT_APP_NAME }}.azurewebsites.net"
        SERVER_URL="https://${{ env.SERVER_APP_NAME }}.azurewebsites.net"
        
        echo "ðŸ§ª Verifying deployment..."
        echo "Client URL: $CLIENT_URL"
        echo "Server URL: $SERVER_URL"
        
        # Test if apps are responding (basic health check)
        if curl -f --connect-timeout 30 --max-time 60 "$CLIENT_URL" > /dev/null 2>&1; then
          echo "âœ… Client app is responding"
        else
          echo "âš ï¸ Client app may still be starting up"
        fi
        
        if curl -f --connect-timeout 30 --max-time 60 "$SERVER_URL" > /dev/null 2>&1; then
          echo "âœ… Server app is responding"  
        else
          echo "âš ï¸ Server app may still be starting up"
        fi

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Web App Container Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Resource Group:** \`${{ env.AZURE_RESOURCE_GROUP }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Updated Applications:" >> $GITHUB_STEP_SUMMARY
        echo "- **Client:** [${{ env.CLIENT_APP_NAME }}](https://${{ env.CLIENT_APP_NAME }}.azurewebsites.net)" >> $GITHUB_STEP_SUMMARY
        echo "- **Server:** [${{ env.SERVER_APP_NAME }}](https://${{ env.SERVER_APP_NAME }}.azurewebsites.net)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Important Notes:" >> $GITHUB_STEP_SUMMARY
        echo "- Container images updated to version \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Application settings preserved** (no environment variables changed)" >> $GITHUB_STEP_SUMMARY
        echo "- Web apps restarted to apply new containers" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "If you need to update environment variables, do so manually in the Azure portal." >> $GITHUB_STEP_SUMMARY